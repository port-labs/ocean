name: Build integration images
on:
  pull_request:
  workflow_dispatch:

env:
  # Maximum allowed image size increase (percentage)
  SIZE_INCREASE_THRESHOLD: ${{ vars.SIZE_INCREASE_THRESHOLD }}

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.prepare-matrix.outputs.INTEGRATIONS_MATRIX }}
    steps:
      - name: Check out code
        uses: actions/checkout@v5
      - name: Prepare matrix
        id: prepare-matrix
        run: |
          integrations_to_build=()
          # Get the list of integrations
          files=$(find integrations/*/.port -name "spec.yaml")
          for file in $files; do
            folder=$(dirname "$file")
            type=$(grep -E '^name = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)

            # Get the version from pyproject.toml
            version=$(grep -E '^version = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)

            # Check if the version exists in the ghcr.io registry
            rc=0
            docker manifest inspect ghcr.io/port-labs/port-ocean-$type:$version > /dev/null 2>&1 || rc=$?

            if [ $rc -eq 0 ]; then
              echo "Image already exists in $repository: port-ocean-$type:$version"
            else
              integrations_to_build+=($file)
            fi
          done
          echo $(echo ${integrations_to_build[@]} | jq -R -c 'split(" ")')
          echo "INTEGRATIONS_MATRIX=$(echo ${integrations_to_build[@]} | jq -R -c 'split(" ")')" >> $GITHUB_OUTPUT

  build-integration:
    runs-on: ubuntu-latest
    if: needs.prepare-matrix.outputs.matrix != '[]'
    outputs:
      is_dev_version: ${{ steps.prepare_tags.outputs.is_dev_version }}
    permissions:
      contents: read
    needs: [prepare-matrix]
    strategy:
      max-parallel: 10
      matrix:
        integration: ${{fromJson(needs.prepare-matrix.outputs.matrix)}}
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Prepare Docker images tags
        id: prepare_tags
        run: |
          current_integration_spec=${{ matrix.integration }}

          folder=$(dirname "$current_integration_spec")
          context_dir=$(dirname "$folder")
          echo "context_dir=$context_dir" >> $GITHUB_OUTPUT

          version=$(grep -E '^version = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)
          type=$(grep -E '^name = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)
          echo "version=$version" >> $GITHUB_OUTPUT

          dockerfile_path=integrations/_infra/Dockerfile
          if test -e $folder/../Dockerfile; then
            echo "Choosing a custom Dockerfile for ${{ matrix.integration }}"
            dockerfile_path=$folder/../Dockerfile
          fi
          echo "dockerfile_path=$dockerfile_path" >> $GITHUB_OUTPUT

          # Check if the 'version' variable contains any character other than digits and "."
          if [[ ! "$version" =~ ^[0-9.]+$ && ! "$version" =~ ^[0-9.]+-beta[0-9]*$ ]]; then
            # If 'version' contains non-numeric and non-dot characters (excluding beta), skip building 'latest' tag
            tags="ghcr.io/port-labs/port-ocean-$type:$version"
            echo "tags=$tags" >> $GITHUB_OUTPUT
            echo "is_dev_version=true" >> $GITHUB_OUTPUT
            echo "Version contains non-numeric characters (excluding beta). Building without 'latest' tag."
          else
            # If 'version' contains only digits and dots or is a beta version, build with both 'latest' and version tags
            tags="ghcr.io/port-labs/port-ocean-$type:$version,ghcr.io/port-labs/port-ocean-$type:latest"
            echo "tags=$tags" >> $GITHUB_OUTPUT
            echo "is_dev_version=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker Image
        id: build
        uses: ./.github/workflows/actions/build-docker-image
        with:
          dockerfile: ${{ steps.prepare_tags.outputs.dockerfile_path }}
          platforms: ${{ matrix.platform }}
          tags: ${{ steps.prepare_tags.outputs.tags }}
          build-args: |
            BUILD_CONTEXT=${{ steps.prepare_tags.outputs.context_dir }}
            INTEGRATION_VERSION=${{ steps.prepare_tags.outputs.version }}
          docker-user: ${{ secrets.DOCKER_MACHINE_USER }}
          docker-password: ${{ secrets.DOCKER_MACHINE_TOKEN }}
          skip-push: 'true'
          load-created-image: 'true'
          skip-login: ${{ github.event_name == 'pull_request' }}

      - name: Extract image info
        id: image_info
        run: |
          SINGLE_TAG=$(echo "${{ steps.prepare_tags.outputs.tags }}" | awk -F ',' '{print $1}')
          IMAGE_NAME=$(echo "${SINGLE_TAG}" | sed 's/.*\///' | cut -d':' -f1)
          PLATFORM_SUFFIX=$(echo "${{ matrix.platform }}" | tr '/' '-')
          echo "image_tag=${SINGLE_TAG}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "platform_suffix=${PLATFORM_SUFFIX}" >> $GITHUB_OUTPUT


      - name: Calculate max allowed size
        id: calc_max_size
        run: |
          THRESHOLD="${{ env.SIZE_INCREASE_THRESHOLD }}"
          IMAGE_NAME="${{ steps.image_info.outputs.image_name }}"

          # Use the 'latest' tag to fetch the baseline image
          BASELINE_IMAGE="ghcr.io/port-labs/${IMAGE_NAME}:latest"

          echo "üì¶ Pulling baseline image: ${BASELINE_IMAGE}"
          if ! docker pull -q "${BASELINE_IMAGE}"; then
              echo "‚ö†Ô∏è Failed to pull baseline image, skipping size limit check"
              echo "skip_check=true" >> $GITHUB_OUTPUT
              exit 0
          fi

          BASELINE_SIZE_BYTES=$(docker image inspect "${BASELINE_IMAGE}" --format='{{.Size}}')

          # Try to get version from label, fallback to 'latest'
          BASELINE_VERSION=$(docker image inspect "${BASELINE_IMAGE}" --format='{{ index .Config.Labels "INTEGRATION_VERSION" }}')
          if [[ -z "$BASELINE_VERSION" ]]; then
            BASELINE_VERSION="latest"
          fi

          if [[ -z "${BASELINE_SIZE_BYTES}" ]] || [[ "${BASELINE_SIZE_BYTES}" == "0" ]]; then
            echo "‚ö†Ô∏è Invalid baseline value, skipping size limit check"
            echo "skip_check=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Calculate max allowed size in bytes: baseline * (1 + threshold/100)
          MAX_SIZE_BYTES=$(jq -n "${BASELINE_SIZE_BYTES} * (1 + ${THRESHOLD} / 100)")
          BASELINE_MB=$(jq -n "${BASELINE_SIZE_BYTES} / 1048576")

          echo "üìä Baseline (from registry): ${BASELINE_MB} MB"
          echo "üìä Baseline Version: ${BASELINE_VERSION}"
          echo "üìä Threshold: ${THRESHOLD}%"

          echo "baseline_bytes=${BASELINE_SIZE_BYTES}" >> $GITHUB_OUTPUT
          echo "baseline_version=${BASELINE_VERSION}" >> $GITHUB_OUTPUT
          echo "max_size_bytes=${MAX_SIZE_BYTES}" >> $GITHUB_OUTPUT
          echo "skip_check=false" >> $GITHUB_OUTPUT

      - name: Check image size limit
        id: size_check
        if: steps.calc_max_size.outputs.skip_check == 'false'
        shell: bash
        env:
          FAIL_ON_LIMIT: "true"
        run: |
          NEW_IMAGE="${{ steps.image_info.outputs.image_tag }}"
          BASELINE_BYTES="${{ steps.calc_max_size.outputs.baseline_bytes }}"
          BASELINE_VERSION="${{ steps.calc_max_size.outputs.baseline_version }}"
          MAX_BYTES="${{ steps.calc_max_size.outputs.max_size_bytes }}"
          THRESHOLD="${{ env.SIZE_INCREASE_THRESHOLD }}"

          NEW_SIZE_BYTES=$(docker image inspect "${NEW_IMAGE}" --format='{{.Size}}')

          # Calculate values for display using jq
          NEW_SIZE_MB=$(jq -n "${NEW_SIZE_BYTES} / 1048576")
          BASELINE_MB=$(jq -n "${BASELINE_BYTES} / 1048576")
          DIFF_MB=$(jq -n "(${NEW_SIZE_BYTES} - ${BASELINE_BYTES}) / 1048576")

          # Format to 2 decimal places
          NEW_SIZE_MB_FMT=$(printf "%.2f" $NEW_SIZE_MB)
          BASELINE_MB_FMT=$(printf "%.2f" $BASELINE_MB)
          DIFF_MB_FMT=$(printf "%.2f" $DIFF_MB)

          IS_OVER=$(jq -n "${NEW_SIZE_BYTES} > ${MAX_BYTES}")

          if [[ "$IS_OVER" == "true" ]]; then
            echo "‚ùå FAILURE: Image size limit exceeded!"
            echo "   Current Size: ${NEW_SIZE_MB_FMT} MB"
            echo "   Baseline Size: ${BASELINE_MB_FMT} MB (Version: ${BASELINE_VERSION})"
            echo "   Difference: +${DIFF_MB_FMT} MB"
            echo "   Allowed Increase: ${THRESHOLD}%"

            if [[ "${FAIL_ON_LIMIT}" == "true" ]]; then
              exit 1
            fi
          else
            echo "‚úÖ SUCCESS: Image size is within limits."
            echo "   Current Size: ${NEW_SIZE_MB_FMT} MB"
            echo "   Baseline Size: ${BASELINE_MB_FMT} MB"
            echo "   Difference: ${DIFF_MB_FMT} MB"
          fi
