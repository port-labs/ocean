name: Release RC
on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch containing core changes'
        required: true
        type: string
      rc_version:
        description: 'RC version (e.g., 0.38.0-rc1)'
        required: true
        type: string

env:
  PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
  PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}

jobs:
  validate-inputs:
    name: Validate inputs
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Check out source branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 1

      - name: Validate version format and pyproject.toml
        id: validate
        run: |
          VERSION="${{ inputs.rc_version }}"

          # Validate RC version format (X.Y.Z-rcN)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-rc[0-9]+$ ]]; then
            echo "::error::Invalid RC version format. Expected: X.Y.Z-rcN (e.g., 0.38.0-rc1)"
            exit 1
          fi

          # Check version in pyproject.toml matches
          PYPROJECT_VERSION=$(grep -E '^version = ".*"' pyproject.toml | cut -d'"' -f2)
          if [[ "$PYPROJECT_VERSION" != "$VERSION" ]]; then
            echo "::error::Version in pyproject.toml ($PYPROJECT_VERSION) doesn't match input ($VERSION). Please update pyproject.toml on the source branch first."
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version validation passed: $VERSION"

      - name: Check tag doesn't exist
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ inputs.rc_version }}$"; then
            echo "::error::Tag v${{ inputs.rc_version }} already exists. Use a different RC version."
            exit 1
          fi
          echo "Tag v${{ inputs.rc_version }} does not exist. Proceeding..."

  publish-core-rc:
    name: Publish RC core to PyPI
    needs: validate-inputs
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Checkout source branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.source_branch }}

      - name: Build package
        run: |
          make install
          make build

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: ${{ env.PYPI_USERNAME }}
          password: ${{ env.PYPI_PASSWORD }}
          packages-dir: ${{ github.workspace }}/dist

      - name: Wait for package to be available on PyPI
        run: |
          VERSION="${{ inputs.rc_version }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0

          echo "Waiting for port-ocean==$VERSION to be available on PyPI..."

          while ! curl -s https://pypi.org/pypi/port-ocean/json | jq -e ".releases | has(\"$VERSION\")" > /dev/null; do
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
              echo "::error::Timeout waiting for package $VERSION to be available on PyPI after $((MAX_ATTEMPTS * 10)) seconds"
              exit 1
            fi
            echo "Waiting for package $VERSION to be available on PyPI... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 10
          done

          echo "Package port-ocean==$VERSION is now available on PyPI"

  tag-source-branch:
    name: Tag source branch and create release
    needs: [validate-inputs, publish-core-rc]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.source_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          VERSION="${{ inputs.rc_version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${VERSION}" -m "Release Candidate ${VERSION}"
          git push origin "refs/tags/v${VERSION}"
          echo "Created and pushed tag v${VERSION}"

      - name: Create GitHub Release (Pre-release)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.rc_version }}
          name: Ocean Framework ${{ inputs.rc_version }} (RC)
          generate_release_notes: true
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  prepare-matrix:
    name: Prepare integration matrix
    runs-on: ubuntu-latest
    needs: publish-core-rc
    outputs:
      matrix: ${{ steps.prepare-matrix.outputs.INTEGRATIONS_MATRIX }}
    steps:
      - name: Check out source branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.source_branch }}

      - name: Prepare matrix of all integrations
        id: prepare-matrix
        run: |
          integrations=()
          # Get the list of all integrations
          files=$(find integrations/*/.port -name "spec.yaml")
          for file in $files; do
            folder=$(dirname "$file")
            # Skip fake-integration (test integration)
            if [[ "$folder" == *"fake-integration"* ]]; then
              echo "Skipping fake-integration"
              continue
            fi
            integrations+=("$file")
          done

          if [ ${#integrations[@]} -eq 0 ]; then
            matrix_json='[]'
            echo "No integrations found"
          else
            matrix_json=$(printf '%s\n' "${integrations[@]}" | jq -R -s -c 'split("\n")[:-1]')
            echo "Found ${#integrations[@]} integrations to build"
          fi

          echo "INTEGRATIONS_MATRIX=$matrix_json" >> $GITHUB_OUTPUT

  build-rc-integrations:
    name: Build RC integration images
    runs-on: ubuntu-latest
    needs: [prepare-matrix, publish-core-rc]
    if: needs.prepare-matrix.outputs.matrix != '[]'
    permissions:
      packages: write
      contents: read
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        integration: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Check out source branch
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.source_branch }}

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: pip install poetry

      - name: Prepare Docker image tags
        id: prepare_tags
        run: |
          current_integration_spec=${{ matrix.integration }}
          folder=$(dirname "$current_integration_spec")
          context_dir=$(dirname "$folder")

          # Get integration name and version
          type=$(grep -E '^name = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)
          version=$(grep -E '^version = ".*"' "$folder/../pyproject.toml" | cut -d'"' -f2)

          echo "context_dir=$context_dir" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "type=$type" >> $GITHUB_OUTPUT

          # Determine Dockerfile path
          dockerfile_path=integrations/_infra/Dockerfile
          if test -e "$folder/../Dockerfile"; then
            dockerfile_path=$folder/../Dockerfile
          fi
          echo "dockerfile_path=$dockerfile_path" >> $GITHUB_OUTPUT

          # RC tag format: rc-{rc_version}
          RC_VERSION="${{ inputs.rc_version }}"
          tags="ghcr.io/port-labs/port-ocean-$type:rc-$RC_VERSION"
          echo "tags=$tags" >> $GITHUB_OUTPUT

          echo "Building $type with RC tag: rc-$RC_VERSION"

      - name: Update integration to use RC core version
        run: |
          RC_VERSION="${{ inputs.rc_version }}"
          INTEGRATION_DIR="${{ steps.prepare_tags.outputs.context_dir }}"
          PYPROJECT_FILE="$INTEGRATION_DIR/pyproject.toml"

          echo "Updating $PYPROJECT_FILE to use port-ocean==$RC_VERSION"

          # Replace the port_ocean dependency line with exact RC version
          # Match patterns like: port_ocean = {version = "^0.37.1", extras = ["cli"]}
          # Replace with: port_ocean = {version = "==X.Y.Z-rcN", extras = ["cli"]}
          sed -i "s/port_ocean = {version = \"[^\"]*\"/port_ocean = {version = \"==$RC_VERSION\"/g" "$PYPROJECT_FILE"

          echo "Updated pyproject.toml:"
          grep "port_ocean" "$PYPROJECT_FILE"

      - name: Regenerate poetry.lock with RC core
        run: |
          cd ${{ steps.prepare_tags.outputs.context_dir }}
          echo "Regenerating poetry.lock for ${{ steps.prepare_tags.outputs.type }}..."
          poetry lock --no-update || poetry lock
          echo "poetry.lock regenerated successfully"

      - name: Build Docker Image
        uses: ./.github/workflows/actions/build-docker-image
        with:
          dockerfile: ${{ steps.prepare_tags.outputs.dockerfile_path }}
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.prepare_tags.outputs.tags }}
          build-args: |
            BUILD_CONTEXT=${{ steps.prepare_tags.outputs.context_dir }}
            INTEGRATION_VERSION=${{ steps.prepare_tags.outputs.version }}
          docker-user: ${{ secrets.DOCKER_MACHINE_USER }}
          docker-password: ${{ secrets.DOCKER_MACHINE_TOKEN }}

  summary:
    name: RC Release Summary
    runs-on: ubuntu-latest
    needs: [validate-inputs, publish-core-rc, tag-source-branch, build-rc-integrations]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## RC Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.rc_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ inputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Inputs | ${{ needs.validate-inputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish Core RC | ${{ needs.publish-core-rc.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag Source Branch | ${{ needs.tag-source-branch.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build RC Integrations | ${{ needs.build-rc-integrations.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.publish-core-rc.result }}" == "success" ]]; then
            echo "### Published Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- **PyPI:** \`pip install port-ocean==${{ inputs.rc_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Docker Images:** \`ghcr.io/port-labs/port-ocean-{integration}:rc-${{ inputs.rc_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Release:** [v${{ inputs.rc_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.rc_version }})" >> $GITHUB_STEP_SUMMARY
          fi
