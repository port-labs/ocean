name: Build docker images
description: Build Docker Images
# NOTE: In composite actions, all parameters are strings,
# thus flags are simply checked by being non empty strings,
# where there the default is an empty string
inputs:
  dockerfile:
    description: Dockerfile to build
    required: true
  tags:
    description: Docker tags to publish
    required: true
  platforms:
    description: Platforms to build (csv)
    required: false
    default: 'linux/arm64,linux/amd64'
  test:
    description: Test command to run on the created image (Optional)
    required: false
    default: ''
  build-args:
    description: Explicit docker build-args
    required: false
    default: ''
  skip-init:
    description: Skip docker init (if ran after another invocation of this action)
    required: false
    default: ''
  docker-user:
    required: false
    description: Docker Hub User
  docker-password:
    required: false
    description: Docker Hub User
  skip-push:
    required: false
    description: Optionally skip push
    default: 'false'
  load-created-image:
    required: false
    description: Optionally load created docker image
    default: ''
  skip-login:
    required: false
    description: Optionally skip docker login
    default: ''
  check-size:
    required: false
    description: Check image size against baseline
    default: 'true'
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ IMAGE SIZE THRESHOLD CONFIGURATION                                      ‚îÇ
  # ‚îÇ Change the default value below to adjust the maximum allowed            ‚îÇ
  # ‚îÇ percentage increase in image size before the build is flagged.          ‚îÇ
  # ‚îÇ Example: '7' means flag if new image is >7% larger than baseline.       ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  size-threshold:
    required: false
    description: Flag if image size increases by more than this percentage
    default: '7'
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ FAIL ON THRESHOLD - Set to 'true' to fail the build when exceeded       ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  fail-on-threshold:
    required: false
    description: Fail the build if size threshold is exceeded
    default: 'false'
  baseline-tag:
    required: false
    description: The tag to use as the baseline for size comparison
    default: 'latest'

outputs:
  new-size-mb:
    description: 'Size of the new image in MB'
    value: ${{ steps.check-size.outputs.new_size_mb }}
  baseline-size-mb:
    description: 'Size of the baseline image in MB'
    value: ${{ steps.check-size.outputs.baseline_size_mb }}
  size-diff-percent:
    description: 'Percentage difference (positive = larger)'
    value: ${{ steps.check-size.outputs.size_diff_percent }}
  threshold-exceeded:
    description: 'Whether the threshold was exceeded'
    value: ${{ steps.check-size.outputs.threshold_exceeded }}

runs:
  using: 'composite'
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      if: ${{ inputs.skip-init == '' }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      if: ${{ inputs.skip-init == '' }}

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      if: ${{ inputs.skip-init == '' && inputs.skip-login == '' }}
      with:
        registry: ghcr.io
        username: ${{ inputs.docker-user }}
        password: ${{ inputs.docker-password }}

    - name: Build Runner Image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.skip-push == 'false' }}
        load: ${{ inputs.test != '' || inputs.load-created-image != '' || inputs.check-size == 'true' }}
        tags: ${{ inputs.tags }}
        build-args: |
          ${{ inputs.build-args }}

    - name: Verify Built Image
      shell: bash
      if: ${{ inputs.test != '' }}
      run: |
        SINGLE_TAG=$(echo "${{ inputs.tags }}" | awk -F ',' '{print $1};' )
        SINGLE_PLATFORM=$(echo "${{ inputs.platforms }}" | awk -F ',' '{print $1};' )
        docker run --platform "${SINGLE_PLATFORM}" --rm --entrypoint bash "${SINGLE_TAG}" -c '${{ inputs.test }}'

    - name: Check Image Size
      id: check-size
      shell: bash
      if: ${{ inputs.check-size == 'true' }}
      env:
        TAGS: ${{ inputs.tags }}
        PLATFORMS: ${{ inputs.platforms }}
        THRESHOLD: ${{ inputs.size-threshold }}
        FAIL_ON_THRESHOLD: ${{ inputs.fail-on-threshold }}
        BASELINE_TAG: ${{ inputs.baseline-tag }}
      run: |
        set -e

        # Get first tag and platform
        SINGLE_TAG=$(echo "${TAGS}" | awk -F ',' '{print $1}')
        SINGLE_PLATFORM=$(echo "${PLATFORMS}" | awk -F ',' '{print $1}')

        # Extract image name (without tag) and tag
        IMAGE_NAME=$(echo "${SINGLE_TAG}" | cut -d':' -f1)
        IMAGE_TAG=$(echo "${SINGLE_TAG}" | cut -d':' -f2)
        BASELINE_IMAGE="${IMAGE_NAME}:${BASELINE_TAG}"
        ARCH=$(echo "${SINGLE_PLATFORM}" | cut -d'/' -f2)

        echo "üîç Checking image sizes..."
        echo "   New image: ${SINGLE_TAG}"
        echo "   Baseline:  ${BASELINE_IMAGE}"
        echo "   Platform:  ${SINGLE_PLATFORM}"

        # Get new image size (loaded locally)
        NEW_SIZE=$(docker image inspect "${SINGLE_TAG}" --format='{{.Size}}' 2>/dev/null || echo "0")

        if [ "${NEW_SIZE}" = "0" ]; then
          echo "‚ö†Ô∏è  Could not get size of new image - skipping check"
          echo "new_size_mb=0" >> $GITHUB_OUTPUT
          echo "baseline_size_mb=0" >> $GITHUB_OUTPUT
          echo "size_diff_percent=0" >> $GITHUB_OUTPUT
          echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        NEW_SIZE_MB=$(echo "scale=2; ${NEW_SIZE} / 1048576" | bc)
        echo "üì¶ New image size: ${NEW_SIZE_MB} MB"

        # Try to get baseline image size from registry manifest
        BASELINE_SIZE=0

        if MANIFEST=$(docker manifest inspect "${BASELINE_IMAGE}" 2>/dev/null); then
          # Get digest for our platform
          DIGEST=$(echo "${MANIFEST}" | jq -r --arg arch "${ARCH}" '
            .manifests[]? | select(.platform.architecture == $arch) | .digest // empty
          ' 2>/dev/null || echo "")

          if [ -n "${DIGEST}" ]; then
            if PLATFORM_MANIFEST=$(docker manifest inspect "${IMAGE_NAME}@${DIGEST}" 2>/dev/null); then
              BASELINE_SIZE=$(echo "${PLATFORM_MANIFEST}" | jq '[.layers[]?.size // 0] | add // 0' 2>/dev/null || echo "0")
            fi
          fi
        fi

        if [ "${BASELINE_SIZE}" = "0" ] || [ "${BASELINE_SIZE}" = "null" ] || [ -z "${BASELINE_SIZE}" ]; then
          echo "‚ö†Ô∏è  No baseline image found - skipping comparison"
          echo "new_size_mb=${NEW_SIZE_MB}" >> $GITHUB_OUTPUT
          echo "baseline_size_mb=0" >> $GITHUB_OUTPUT
          echo "size_diff_percent=0" >> $GITHUB_OUTPUT
          echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        BASELINE_SIZE_MB=$(echo "scale=2; ${BASELINE_SIZE} / 1048576" | bc)

        # Calculate percentage difference
        DIFF_PERCENT=$(echo "scale=2; ((${NEW_SIZE} - ${BASELINE_SIZE}) * 100) / ${BASELINE_SIZE}" | bc)

        echo ""
        echo "üìä Size comparison:"
        echo "   Baseline: ${BASELINE_SIZE_MB} MB"
        echo "   New:      ${NEW_SIZE_MB} MB"
        echo "   Change:   ${DIFF_PERCENT}%"

        # Check threshold
        THRESHOLD_EXCEEDED="false"
        if [ "$(echo "${DIFF_PERCENT} > ${THRESHOLD}" | bc)" -eq 1 ]; then
          THRESHOLD_EXCEEDED="true"
          echo ""
          echo "üö® Image size increased by ${DIFF_PERCENT}%, exceeds ${THRESHOLD}% threshold!"
        elif [ "$(echo "${DIFF_PERCENT} > 0" | bc)" -eq 1 ]; then
          echo "üìà Within ${THRESHOLD}% threshold"
        else
          echo "üìâ Size decreased or unchanged üéâ"
        fi

        echo "new_size_mb=${NEW_SIZE_MB}" >> $GITHUB_OUTPUT
        echo "baseline_size_mb=${BASELINE_SIZE_MB}" >> $GITHUB_OUTPUT
        echo "size_diff_percent=${DIFF_PERCENT}" >> $GITHUB_OUTPUT
        echo "threshold_exceeded=${THRESHOLD_EXCEEDED}" >> $GITHUB_OUTPUT

        # Fail the build if threshold exceeded and fail-on-threshold is enabled
        if [ "${THRESHOLD_EXCEEDED}" = "true" ] && [ "${FAIL_ON_THRESHOLD}" = "true" ]; then
          echo ""
          echo "‚ùå Build failed: image size increase exceeds ${THRESHOLD}% threshold"
          exit 1
        fi
