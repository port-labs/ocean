name: Check Schema Diff
description: Checks out the repo, installs dependencies, extracts the port-app-config schema, and compares it against the base schema from main.

inputs:
  integration_type:
    description: The integration type
    required: true
  integration_folder:
    description: The integration folder
    required: true

runs:
  using: composite
  steps:
    - name: Checkout Repo
      uses: actions/checkout@v5

    - name: Configure AWS Credentials ðŸ”’
      id: aws-credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'poetry'

    - name: Install dependencies
      shell: bash
      working-directory: ${{ format('integrations/{0}', inputs.integration_folder) }}
      run: |
        pipx install 'poetry>=1.0.0,<2.0.0'
        make install
        cargo install json-schema-diff

    - name: Compare Schemas and Report
      shell: bash
      working-directory: ${{ format('integrations/{0}', inputs.integration_folder) }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        poetry run port-app-config schema . -o ${{ inputs.integration_type }}.revision.json
        aws s3 cp s3://ocean-registry/${{ inputs.integration_type }}/port-app-config.json ${{ inputs.integration_type }}.base.json

        DIFF_OUTPUT=$(json-schema-diff "${{ inputs.integration_type }}.base.json" "${{ inputs.integration_type }}.revision.json" 2>&1) || true

        if [ -z "$DIFF_OUTPUT" ]; then
          echo "âœ… No schema changes detected for ${INTEGRATION}"
          exit 0
        fi

        HAS_BREAKING=false
        BREAKING_ROWS=""
        NON_BREAKING_ROWS=""

        while IFS= read -r line; do
          [ -z "$line" ] && continue

          path=$(echo "$line" | jq -r '.path')
          change_type=$(echo "$line" | jq -r '.change | keys[0]')
          details=$(echo "$line" | jq -c '.change | to_entries[0].value')
          is_breaking=$(echo "$line" | jq -r '.is_breaking')

          row="| \`${path}\` | \`${change_type}\` | \`${details}\` |"

          if [ "$is_breaking" = "true" ]; then
            HAS_BREAKING=true
            BREAKING_ROWS+="${row}"$'\n'
          else
            NON_BREAKING_ROWS+="${row}"$'\n'
          fi
        done <<< "$DIFF_OUTPUT"

        {
          echo "## ðŸ” Port App Config Schema Changes â€” \`${{ inputs.integration_type }}\`"
          echo ""

          if [ -n "$BREAKING_ROWS" ]; then
            echo "### âš ï¸ Breaking Changes"
            echo ""
            echo "| Path | Change | Details |"
            echo "|------|--------|---------|"
            echo -n "$BREAKING_ROWS"
            echo ""
          fi

          if [ -n "$NON_BREAKING_ROWS" ]; then
            echo "### âœ… Non-Breaking Changes"
            echo ""
            echo "| Path | Change | Details |"
            echo "|------|--------|---------|"
            echo -n "$NON_BREAKING_ROWS"
            echo ""
          fi

          if [ "$HAS_BREAKING" = "true" ]; then
            echo "---"
            echo "> **âš ï¸ Action Required:** This PR introduces breaking changes to the \`${{ inputs.integration_type }}\` port-app-config schema."
            echo "> Please verify these changes are intentional and check the **Breaking change** checkbox in the PR description to acknowledge."
          fi
        } > /tmp/schema-diff-comment.md

        cat /tmp/schema-diff-comment.md

        if [ -n "${{ github.event.pull_request.number }}" ]; then
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body-file /tmp/schema-diff-comment.md
        fi

        if [ "$HAS_BREAKING" = "true" ]; then
          echo "::error::Breaking schema changes detected for ${{ inputs.integration_type }}"
          exit 1
        fi
