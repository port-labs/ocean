type: harbor
description: Harbor Integration for Port using Ocean Framework
icon: Harbor
saas: false
features:
  - type: exporter
    section: Container Registries
  - type: webhook
    section: Container Registries

configurations:
  - name: harbor_host
    type: string
    required: true
    description: Harbor instance URL (e.g., http://localhost:8081 or https://harbor.example.com)

  - name: harbor_username
    type: string
    required: true
    description: Harbor username (robot account recommended, format robot$project+name for project-level or robot$name for system-level)

  - name: harbor_password
    type: string
    required: true
    sensitive: true
    description: Harbor password or robot account token

  - name: verify_ssl
    type: boolean
    required: false
    default: true
    description: Verify SSL certificates when connecting to Harbor

  - name: project_filter
    type: object
    required: false
    description: Filter projects to sync
    properties:
      visibility:
        type: string
        enum: [public, private, all]
        default: all
        description: Filter projects by visibility
      name_prefix:
        type: string
        description: Filter projects by name prefix

  - name: repository_filter
    type: object
    required: false
    description: Filter repositories to sync
    properties:
      name_contains:
        type: string
        description: Filter repositories where name contains this string
      name_starts_with:
        type: string
        description: Filter repositories where name starts with this prefix

  - name: artifact_filter
    type: object
    required: false
    description: Filter artifacts to sync
    properties:
      min_severity:
        type: string
        enum: [negligible, low, medium, high, critical]
        description: Only sync artifacts with vulnerability severity at or above this level
      tag:
        type: string
        description: Filter artifacts by tag name (exact match or pattern)
      digest:
        type: string
        description: Filter artifacts by digest prefix
      label:
        type: string
        description: Filter artifacts that have this label
      media_type:
        type: string
        description: Filter artifacts by media type (e.g., application/vnd.docker.distribution.manifest.v2+json)
      created_since:
        type: string
        description: Filter artifacts created since this date (ISO 8601 format, e.g., 2024-01-01T00:00:00Z)

  - name: webhook_secret
    type: string
    required: false
    sensitive: true
    description: Shared secret for webhook signature validation (optional but recommended)

resources:
  - kind: project
    selector:
      query: "true"
    port:
      entity:
        mappings:
          identifier: .name
          title: .name
          blueprint: '"harborProject"'
          properties:
            ownerName: .owner_name
            public: .metadata.public == "true"
            repoCount: .repo_count
            createdAt: .creation_time
            updatedAt: .update_time

  - kind: user
    selector:
      query: "true"
    port:
      entity:
        mappings:
          identifier: .user_id | tostring
          title: .username
          blueprint: '"harborUser"'
          properties:
            email: .email
            realname: .realname
            hasAdminRole: .has_admin_role
            createdAt: .creation_time
            updatedAt: .update_time

  - kind: repository
    selector:
      query: "true"
    port:
      entity:
        mappings:
          identifier: .name | gsub("/"; "-")
          title: .name
          blueprint: '"harborRepository"'
          properties:
            artifactCount: .artifact_count
            pullCount: .pull_count
            createdAt: .creation_time
            updatedAt: .update_time
            description: .description
          relations:
            project: .__project.name

  - kind: artifact
    selector:
      query: "true"
    port:
      entity:
        mappings:
          identifier: (.__repository.name + "-" + (.digest[:12])) | gsub("/"; "-")
          title: .__title
          blueprint: '"harborArtifact"'
          properties:
            digest: .digest
            size: .size
            pushTime: .push_time
            pullTime: .pull_time
            tags: .__tags
            labels: .__labels
            scanStatus: .scanStatus
            scanSeverity: .scanSeverity
            vulnerabilityCritical: .vulnerabilityCritical
            vulnerabilityHigh: .vulnerabilityHigh
            vulnerabilityMedium: .vulnerabilityMedium
            vulnerabilityLow: .vulnerabilityLow
            vulnerabilityTotal: .vulnerabilityTotal
          relations:
            repository: .__repository.name | gsub("/"; "-")
