import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from port_ocean.core.handlers.webhook.webhook_event import (
    WebhookEvent,
    WebhookEventRawResults,
)
from port_ocean.core.handlers.port_app_config.models import (
    PortResourceConfig,
    EntityMapping,
    MappingsConfig,
    ResourceConfig,
    Selector,
)

from webhook.processors.vulnerability_processor import (
    VulnerabilityWebhookProcessor,
)
from integration import ObjectKind
from tests.conftest import SAMPLE_VULNERABILITY_DATA


@pytest.fixture
def resource_config() -> ResourceConfig:
    """Create a resource config fixture for vulnerability."""
    return ResourceConfig(
        kind="sn_vul_vulnerable_item",
        selector=Selector(query="true"),
        port=PortResourceConfig(
            entity=MappingsConfig(
                mappings=EntityMapping(
                    identifier=".sys_id",
                    title=".number",
                    blueprint='"servicenowVulnerability"',
                    properties={},
                )
            )
        ),
    )


@pytest.fixture
def vulnerability_processor(
    mock_webhook_event: WebhookEvent,
) -> VulnerabilityWebhookProcessor:
    """Create a vulnerability webhook processor fixture."""
    return VulnerabilityWebhookProcessor(event=mock_webhook_event)


@pytest.mark.asyncio
class TestVulnerabilityWebhookProcessor:
    """Test suite for VulnerabilityWebhookProcessor."""

    async def test_get_matching_kinds(
        self, vulnerability_processor: VulnerabilityWebhookProcessor
    ) -> None:
        """Test that get_matching_kinds returns the correct kind."""
        mock_event = MagicMock(spec=WebhookEvent)

        kinds = await vulnerability_processor.get_matching_kinds(mock_event)

        assert kinds == [ObjectKind.VULNERABILITY]

    async def test_should_process_event_valid(
        self, vulnerability_processor: VulnerabilityWebhookProcessor
    ) -> None:
        """Test that _should_process_event returns True for correct class name."""
        mock_event = MagicMock(spec=WebhookEvent)
        mock_event.payload = {
            "cmdb_ci": "test123",
            "state": "2",
            "sys_id": "test123",
        }

        result = vulnerability_processor._should_process_event(mock_event)

        assert result is True

    async def test_should_process_event_invalid(
        self, vulnerability_processor: VulnerabilityWebhookProcessor
    ) -> None:
        """Test that _should_process_event returns False for incorrect class name."""
        mock_event = MagicMock(spec=WebhookEvent)
        mock_event.payload = {"sys_class_name": "incident", "sys_id": "test123"}

        result = vulnerability_processor._should_process_event(mock_event)

        assert result is False

    async def test_handle_event_found(
        self,
        vulnerability_processor: VulnerabilityWebhookProcessor,
        resource_config: ResourceConfig,
    ) -> None:
        """Test handling an event when the record is found."""
        payload = {
            "sys_id": SAMPLE_VULNERABILITY_DATA["sys_id"],
            "cmdb_ci": "test123",
            "state": "2",
        }

        mock_client = MagicMock()
        mock_client.get_record_by_sys_id = AsyncMock(
            return_value=SAMPLE_VULNERABILITY_DATA
        )

        with patch(
            "webhook.processors.vulnerability_processor.initialize_webhook_client",
            return_value=mock_client,
        ):
            result = await vulnerability_processor.handle_event(
                payload, resource_config
            )

            assert isinstance(result, WebhookEventRawResults)
            assert result.updated_raw_results == [SAMPLE_VULNERABILITY_DATA]
            assert result.deleted_raw_results == []

    async def test_handle_event_deleted(
        self,
        vulnerability_processor: VulnerabilityWebhookProcessor,
        resource_config: ResourceConfig,
    ) -> None:
        """Test handling an event when the record is not found."""
        payload = {
            "sys_id": "deleted_id",
            "cmdb_ci": "test123",
            "state": "2",
        }

        mock_client = MagicMock()
        mock_client.get_record_by_sys_id = AsyncMock(return_value=None)

        with patch(
            "webhook.processors.vulnerability_processor.initialize_webhook_client",
            return_value=mock_client,
        ):
            result = await vulnerability_processor.handle_event(
                payload, resource_config
            )

            assert isinstance(result, WebhookEventRawResults)
            assert result.updated_raw_results == []
            assert result.deleted_raw_results == [payload]
